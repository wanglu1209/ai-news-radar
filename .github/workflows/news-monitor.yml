name: AI News Monitor

on:
  # å®šæ—¶ä»»åŠ¡ï¼šæ¯6å°æ—¶è¿è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 */6 * * *'  # åŒ—äº¬æ—¶é—´: 8:00, 14:00, 20:00, 2:00
  
  # ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # æ¨é€åˆ°mainåˆ†æ”¯æ—¶ä¹Ÿè§¦å‘ï¼ˆç”¨äºæµ‹è¯•ï¼‰
  push:
    branches:
      - main
    paths:
      - '**.py'
      - 'config.yaml'
      - '.github/workflows/news-monitor.yml'

jobs:
  fetch-and-notify:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        # éœ€è¦è·å–å®Œæ•´å†å²ä»¥ä¾¿æäº¤æ›´æ–°
        fetch-depth: 0
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: åˆ›å»ºé…ç½®æ–‡ä»¶
      run: |
        # ä»é…ç½®æ¨¡æ¿åˆ›å»ºå®é™…é…ç½®
        if [ ! -f config.yaml ]; then
          cp config.yaml.example config.yaml
          echo "âœ… å·²åˆ›å»ºé…ç½®æ–‡ä»¶"
        fi
    
    - name: è¿è¡Œæ–°é—»ç›‘æ§
      env:
        # ä»GitHub Secretsè·å–ä¼ä¸šå¾®ä¿¡Webhook
        WECOM_WEBHOOK: ${{ secrets.WECOM_WEBHOOK }}
      run: |
        python main.py
    
    - name: æäº¤æ›´æ–°çš„å†å²è®°å½•
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # æ·»åŠ æ•°æ®æ–‡ä»¶
        git add data/news_history.json || true
        
        # å¦‚æœæœ‰å˜æ›´åˆ™æäº¤
        if git diff --staged --quiet; then
          echo "ğŸ“ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ–°"
        else
          git commit -m "chore: update news history [skip ci]"
          git push
          echo "âœ… å†å²è®°å½•å·²æ›´æ–°"
        fi
    
    - name: ä¸Šä¼ æ—¥å¿—ï¼ˆå¦‚æœå¤±è´¥ï¼‰
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: logs
        path: |
          *.log
        retention-days: 7

